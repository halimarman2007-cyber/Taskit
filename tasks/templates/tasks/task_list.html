{% extends "base.html" %}
{% block content %}

<!-- Banner -->
<div class="w-full h-56 overflow-hidden">
    <img
        src="https://images.unsplash.com/photo-1501785888041-af3ef285b470"
        class="w-full h-full object-cover opacity-90"
        alt="Banner"
    >
</div>

<!-- Main Container -->
<div class="max-w-[1800px] px-12 -mt-20 relative">

    <!-- Page Title -->
    <div class="mt-40 mb-10">
        <h1 class="text-3xl font-semibold">Master Planner</h1>
        <p class="text-muted mt-2 text-sm">
            Plan, assign, and track everything in one place
        </p>
    </div>

    <!-- Scratchpad -->
    <div
        class="bg-panel border border-border rounded-lg p-4 mb-10"
        x-data="{
            content: `{{ scratchpad.content|escapejs }}`,
            saving:false,
            t:null,
            queue(){
                clearTimeout(this.t)
                this.t=setTimeout(()=>this.save(),600)
            },
            save(){
                this.saving=true
                fetch('/scratchpad/save/',{
                    method:'POST',
                    headers:{
                        'X-CSRFToken':'{{ csrf_token }}',
                        'Content-Type':'application/x-www-form-urlencoded'
                    },
                    body:new URLSearchParams({content:this.content})
                }).then(()=>this.saving=false)
            }
        }"
    >
        <p class="text-sm font-medium mb-2">Scratchpad</p>
        <textarea
            x-model="content"
            @input="
                $el.style.height='auto';
                $el.style.height=$el.scrollHeight+'px';
                queue()
            "
            placeholder="Write anything here…"
            class="w-full bg-transparent text-sm resize-none focus:outline-none overflow-hidden min-h-[120px]"
        ></textarea>
        <div class="text-xs text-muted mt-1">
            <span x-show="saving">Saving…</span>
            <span x-show="!saving">Saved</span>
        </div>
    </div>

    <!-- TASKS -->
    <div
        class="bg-panel border border-border rounded-lg mb-10 overflow-hidden"
        x-data="{
            showNew:false,
            title:'',
            due:'',
            priority:'medium',
            assignee:'',
            created:false,
            ready(){ return this.title && this.due && this.assignee },
            autoCreate(){
                if(this.ready() && !this.created){
                    this.created=true
                    fetch('/tasks/create/inline/',{
                        method:'POST',
                        headers:{'Content-Type':'application/x-www-form-urlencoded'},
                        body:new URLSearchParams({
                            title:this.title,
                            due_date:this.due,
                            priority:this.priority,
                            assignee:this.assignee,
                            status:'todo'
                        })
                    }).then(()=>location.reload())
                }
            }
        }"
    >

        <div class="px-4 py-3 border-b border-border flex items-center justify-between">
            <p class="text-sm font-medium">Tasks</p>
            <button
                @click="showNew=!showNew"
                class="text-sm text-muted hover:text-white transition"
            >
                + New
            </button>
        </div>

        <table class="w-full text-sm">
            <thead class="text-muted border-b border-border">
                <tr>
                    <th class="px-4 py-2 text-left">Title</th>
                    <th class="px-4 py-2 text-left">Notes</th>
                    <th class="px-4 py-2 text-left">Due</th>
                    <th class="px-4 py-2 text-left">Priority</th>
                    <th class="px-4 py-2 text-left">Assignee</th>
                    <th class="px-4 py-2 text-left">Status</th>
                </tr>
            </thead>

            <tbody>

                <!-- NEW TASK -->
                <tr x-show="showNew" class="border-b border-border bg-[#1a1a1e]">
                    <td class="px-4 py-3">
                        <input x-model="title" @input="autoCreate()"
                               placeholder="Task title"
                               class="bg-transparent border-b border-border focus:outline-none w-full">
                    </td>
                    <td class="px-4 py-3">—</td>
                    <td class="px-4 py-3">
                        <input type="date" x-model="due" @input="autoCreate()"
                               class="bg-transparent border border-border rounded px-2 py-1 text-sm">
                    </td>
                    <td class="px-4 py-3">
                        <select x-model="priority" @change="autoCreate()"
                                class="bg-transparent border border-border rounded px-2 py-1 text-sm">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        <select x-model="assignee" @change="autoCreate()"
                                class="bg-transparent border border-border rounded px-2 py-1 text-sm">
                            <option value="">Assign to…</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="px-4 py-3 text-muted">To do</td>
                </tr>

                <!-- EXISTING TASKS -->
                {% for task in active_tasks %}
                <tr id="task-{{ task.id }}" class="border-b border-border hover:bg-[#1f1f23] scroll-mt-32">
                    <td class="px-4 py-3">{{ task.title }}</td>
                    <td class="px-4 py-3 text-muted">{{ task.description|default:"—" }}</td>
                    <td class="px-4 py-3">{{ task.due_date }}</td>
                    <td class="px-4 py-3">{{ task.priority }}</td>
                    <td class="px-4 py-3">{{ task.assignee.username }}</td>
                    <td class="px-4 py-3">{{ task.status }}</td>
                </tr>
                {% endfor %}

            </tbody>
        </table>
    </div>

    <!-- CALENDAR -->
    <div class="bg-panel border border-border rounded-lg p-4 mb-20">

        <div class="flex items-center justify-between mb-4">
            <a href="?year={{ prev_year }}&month={{ prev_month }}"
               class="text-muted hover:text-white text-lg">‹</a>

            <p class="text-sm font-medium">{{ current_month }}</p>

            <a href="?year={{ next_year }}&month={{ next_month }}"
               class="text-muted hover:text-white text-lg">›</a>
        </div>

        <div class="grid grid-cols-7 text-xs text-muted mb-2">
            <div>Mon</div><div>Tue</div><div>Wed</div>
            <div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>

        <div class="grid grid-cols-7 gap-px bg-border rounded overflow-hidden">
            {% for week in month_calendar %}
                {% for day in week %}
                <div class="min-h-[120px] bg-[#141416] p-2 text-xs space-y-1">
                    {% if day %}
                        {% if day == today_day %}
                            <div class="w-6 h-6 flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-medium">
                                {{ day }}
                            </div>
                        {% else %}
                            <div class="text-muted">{{ day }}</div>
                        {% endif %}

                        {% for task in calendar_tasks %}
                            {% if task.due_date.day == day %}
                                <div
                                    class="px-2 py-1 rounded text-xs truncate bg-blue-500/30 text-blue-300 cursor-pointer"
                                    onclick="document.getElementById('task-{{ task.id }}')?.scrollIntoView({behavior:'smooth',block:'center'})"
                                >
                                    {{ task.title }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

</div>
{% endblock %}
