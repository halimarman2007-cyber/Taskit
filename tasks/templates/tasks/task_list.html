{% extends "base.html" %}
{% block content %}

<!-- Banner -->
<div class="w-full h-56 overflow-hidden">
    <img
        src="https://images.unsplash.com/photo-1501785888041-af3ef285b470"
        class="w-full h-full object-cover opacity-90"
        alt="Banner"
    >
</div>

<!-- Main Container -->
<div class="max-w-[1800px] px-12 -mt-20 relative">

    <!-- Page Title -->
    <div class="mt-40 mb-10">
        <h1 class="text-3xl font-semibold">Master Planner</h1>
        <p class="text-muted mt-2 text-sm">
            Plan, assign, and track everything in one place
        </p>
    </div>

    <!-- Scratchpad -->
    <div
        class="bg-panel border border-border rounded-lg p-4 mb-10"
        x-data="{
            content: `{{ scratchpad.content|escapejs }}`,
            saving:false,
            timeout:null,
            queue(){
                clearTimeout(this.timeout)
                this.timeout=setTimeout(()=>this.save(),600)
            },
            save(){
                this.saving=true
                fetch('/scratchpad/save/',{
                    method:'POST',
                    headers:{
                        'X-CSRFToken':'{{ csrf_token }}',
                        'Content-Type':'application/x-www-form-urlencoded'
                    },
                    body:new URLSearchParams({content:this.content})
                }).then(()=>this.saving=false)
            }
        }"
    >
        <p class="text-sm font-medium mb-2">Scratchpad</p>

        <textarea
            x-model="content"
            @input="
                $el.style.height='auto';
                $el.style.height=$el.scrollHeight+'px';
                queue()
            "
            placeholder="Write anything here…"
            class="w-full bg-transparent text-sm resize-none focus:outline-none overflow-hidden min-h-[120px]"
        ></textarea>

        <div class="text-xs text-muted mt-1">
            <span x-show="saving">Saving…</span>
            <span x-show="!saving">Saved</span>
        </div>
    </div>

    <!-- TASKS -->
    <div
        class="bg-panel border border-border rounded-lg mb-10 overflow-hidden"
        x-data="{
            showNew:false,
            title:'',
            due:'',
            priority:'medium',
            assignee:'',
            saving:false,
            created:false,

            ready(){
                return this.title && this.due && this.assignee
            },

            autoCreate(){
                if(this.ready() && !this.created){
                    this.created = true
                    this.create()
                }
            },

            create(){
                this.saving=true
                fetch('/tasks/create/inline/',{
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body:new URLSearchParams({
                        title:this.title,
                        due_date:this.due,
                        priority:this.priority,
                        assignee:this.assignee,
                        status:'todo'
                    })
                })
                .then(()=>location.reload())
            }
        }"

    >

        <!-- Header -->
        <div class="px-4 py-3 border-b border-border flex items-center justify-between">
            <p class="text-sm font-medium">Tasks</p>
            <button
                @click="showNew=!showNew"
                class="text-sm text-muted hover:text-white transition"
            >
                + New
            </button>
        </div>

        <table class="w-full text-sm">
            <thead class="text-muted border-b border-border">
                <tr>
                    <th class="px-4 py-2 text-left">Title</th>
                    <th class="px-4 py-2 text-left">Notes</th>
                    <th class="px-4 py-2 text-left">Due</th>
                    <th class="px-4 py-2 text-left">Priority</th>
                    <th class="px-4 py-2 text-left">Assignee</th>
                    <th class="px-4 py-2 text-left">Status</th>
                </tr>
            </thead>

            <tbody>

                <!-- NEW TASK ROW -->
                <tr x-show="showNew" class="border-b border-border bg-[#1a1a1e]">
                    <td class="px-4 py-3">
                        <input
                            x-model="title"
                            @input="autoCreate()"
                            placeholder="Task title"
                            class="bg-transparent border-b border-border focus:outline-none w-full"
                        >
                    </td>

                    <td class="px-4 py-3">—</td>

                    <td class="px-4 py-3">
                        <input
                            type="date"
                            @input="autoCreate()"
                            x-model="due"
                            class="bg-transparent border border-border rounded px-2 py-1 text-sm"
                        >
                    </td>

                    <td class="px-4 py-3">
                        <select
                            x-model="priority"
                            @change="autoCreate()"
                            class="bg-transparent border border-border rounded px-2 py-1 text-sm"
                        >
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </td>

                    <td class="px-4 py-3">
                        <select
                            x-model="assignee"
                            @change="autoCreate()"
                            class="bg-transparent border border-border rounded px-2 py-1 text-sm"
                        >
                            <option value="">Assign to…</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    <td class="px-4 py-3 text-muted">To do</td>
                </tr>

                <!-- EXISTING TASKS -->
                {% for task in active_tasks %}
                <tr class="border-b border-border hover:bg-[#1f1f23]">

                    <!-- TITLE -->
                    <td class="px-4 py-3">
                        <div x-data="{editing:false,value:'{{ task.title|escapejs }}'}">
                            <span x-show="!editing"
                                  @click="editing=true;$nextTick(()=> $refs.i.focus())"
                                  x-text="value"
                                  class="cursor-pointer hover:underline"></span>
                            <input x-show="editing" x-ref="i"
                                   x-model="value"
                                   @blur="editing=false;
                                   fetch('/tasks/{{ task.id }}/update/',{
                                       method:'POST',
                                       headers:{'Content-Type':'application/x-www-form-urlencoded'},
                                       body:new URLSearchParams({field:'title',value:value})
                                   })"
                                   class="bg-transparent border-b border-border focus:outline-none w-full">
                        </div>
                    </td>

                    <!-- NOTES -->
                    <td class="px-4 py-3 text-muted">
                        {{ task.description|default:"—" }}
                    </td>

                    <!-- DUE -->
                    <td class="px-4 py-3">
                        <input type="date"
                               value="{{ task.due_date|date:'Y-m-d' }}"
                               @change="
                                   fetch('/tasks/{{ task.id }}/update/',{
                                       method:'POST',
                                       headers:{'Content-Type':'application/x-www-form-urlencoded'},
                                       body:new URLSearchParams({field:'due_date',value:$event.target.value})
                                   })"
                               class="bg-transparent border border-border rounded px-2 py-1 text-sm">
                    </td>

                    <!-- PRIORITY -->
                    <td class="px-4 py-3">
                        <select
                            @change="
                                fetch('/tasks/{{ task.id }}/update/',{
                                    method:'POST',
                                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                                    body:new URLSearchParams({field:'priority',value:$event.target.value})
                                })"
                            class="bg-transparent border border-border rounded px-2 py-1 text-sm"
                        >
                            <option value="low" {% if task.priority == "low" %}selected{% endif %}>Low</option>
                            <option value="medium" {% if task.priority == "medium" %}selected{% endif %}>Medium</option>
                            <option value="high" {% if task.priority == "high" %}selected{% endif %}>High</option>
                        </select>
                    </td>

                    <!-- ASSIGNEE -->
                    <td class="px-4 py-3">
                        <select
                            @change="
                                fetch('/tasks/{{ task.id }}/update/',{
                                    method:'POST',
                                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                                    body:new URLSearchParams({field:'assignee_id',value:$event.target.value})
                                })"
                            class="bg-transparent border border-border rounded px-2 py-1 text-sm"
                        >
                            {% for user in users %}
                                <option value="{{ user.id }}"
                                    {% if user.id == task.assignee.id %}selected{% endif %}>
                                    {{ user.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- STATUS -->
                    <td class="px-4 py-3">
                        <select
                            @change="
                                fetch('/tasks/{{ task.id }}/update/',{
                                    method:'POST',
                                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                                    body:new URLSearchParams({field:'status',value:$event.target.value})
                                }).then(()=>location.reload())"
                            class="bg-transparent border border-border rounded px-2 py-1 text-sm"
                        >
                            <option value="todo" {% if task.status == "todo" %}selected{% endif %}>To do</option>
                            <option value="in_progress" {% if task.status == "in_progress" %}selected{% endif %}>In progress</option>
                            <option value="done" {% if task.status == "done" %}selected{% endif %}>Done</option>
                        </select>
                    </td>

                </tr>
                {% endfor %}

                {% if done_tasks %}
                <tr>
                    <td colspan="6" class="px-4 py-2 text-xs text-muted">Completed</td>
                </tr>
                {% endif %}

                {% for task in done_tasks %}
                <tr class="opacity-50 border-b border-border">
                    <td class="px-4 py-3 line-through">{{ task.title }}</td>
                    <td class="px-4 py-3">—</td>
                    <td class="px-4 py-3">{{ task.due_date }}</td>
                    <td class="px-4 py-3">—</td>
                    <td class="px-4 py-3">{{ task.assignee.username }}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">Done</span>
                    </td>
                </tr>
                {% endfor %}

            </tbody>
        </table>
    </div>

    <!-- Calendar -->
    <div class="bg-panel border border-border rounded-lg p-4 mb-20">
        <p class="text-muted text-sm">(Monthly calendar view will go here)</p>
    </div>

</div>
{% endblock %}
